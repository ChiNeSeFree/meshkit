{{extend 'layout.html'}}
{{footer_enable=True}}



<h1>{{=T('1. Basic configuration')}}</h1>

<div id="custom_text_start">
	{{=XML(startpage)}}
</div>


{{if config.documentation_url:}}
<div id="docurl">
  {{=XML(T('If you need help with Meshkit please see: %(url)s.') %
         dict(url='<a href="' + config.documentation_url + '">' + T('Meshkit Documentation') + '</a>'))}}
</div>
{{pass}}


    <form method="post" name="step1" enctype="multipart/form-data" action="">

{{
field_target = formhelpers.formfield()
field_target.Name = 'target'
field_target.Label = T('Target')
field_target.Valuelist = targets
field_target.Valueselected = request.vars.target
field_target.Helptext = T('For which hardware platform you want to build an image. If you are unsure which is the right one for your device visit the openwrt wiki and search for your device there.')
field_target = field_target.select()

field_noconf = formhelpers.formfield()
field_noconf.Name = 'noconf'
field_noconf.Label = T('No configuration')
field_noconf.Value = session.noconf
field_noconf.Helptext = T('If you check this option meshkit will only build your images, but not configure your system. Also it is still possible to select packages and upload your own files.')
field_noconf = field_noconf.chkbox()

field_expert = formhelpers.formfield()
field_expert.Name = 'expert'
field_expert.Label = T('Expert')
field_expert.Helptext = T('Enable this to show much more options for customizing your firmware.')
field_expert.Value = session.expert
field_expert = field_expert.chkbox()


field_mail = formhelpers.formfield()
field_mail.Name = 'mail'
field_mail.Label = T('Email')
field_mail.Helptext = T('Enter your email address here. After the images have been built you will receive an email with download links for the firmware.')
field_mail.Value = request.vars.mail or user_email or ''
field_mail = field_mail.input()
}}

{{if config.communitysupport == True:
    field_community = formhelpers.formfield()
    field_community.Name = 'community'
    field_community.Label = T('Community')
    field_community.Valuelist = communities
    field_community.Valueselected = session.community
    field_community.Helptext = T('Please select your wireless community here. This will select reasonable defaults for step 2 of the image configuration.')
    field_community = field_community.select()
      
}}
 
{{=field_community}}
{{pass}}

        

        

{{=field_target}}

{{=field_expert}}

{{if not config.noconf == True:}}
    {{=field_noconf}}
{{pass}}
        
{{=field_mail}}
            
        <input type="submit" value="SUBMIT"/>
        <input type="hidden" name="profile" id="imageconf_profile"/>
        <input type="hidden" name="routerinfo" id="imageconf_routerinfo" />
        <input type="hidden" name="_formname" value="step1" />
    </form>
<div style="height:35px"></div>

<h2>{{=T('Select by model')}}</h2>
<p>{{=T('You may select some known router models below. The target on this page and the profile on the next page will automatically be set for you then.')}}<br />
{{=T('If your model is not shown below then continue by setting target and profile (on the next page) manually.')}}</p>

<div id="modellist">
</div>
<script type="text/javascript">

var modellist = {{=XML(modellist)}};
var target_options = document.getElementById('imageconf_target').options;

function target_rewrite(target) {
    for(option in target_options) {
	var ret;
	if(typeof target_options[option].value != "undefined"){
          if (target_options[option].value.match(target)) {
             ret = target_options[option].value;
          }
	}
    }
    return ret;
}


function set_target(target) {
    $('select[name="target"]').val(target);
}

function set_profile(profile) {
    $('input[name="profile"]').val(profile);
}

var list = "<table>";

for(var manufacturer in modellist) {
  var len = Object.keys(modellist[manufacturer]).length;
  list += '<tr>';
  list += '<th>' + manufacturer + '</th>';
  var i = 1;
  for(var model in modellist[manufacturer]) {
    list += '<td>';
    var target = modellist[manufacturer][model]['target'];
    var profile = modellist[manufacturer][model]['profile'];
    var full_target = target_rewrite(target);
    msg = '{{=T('Selected')}} ' + model + '<ul><li>{{=T('Target')}}: ' + full_target + '</li><li>{{=T('Profile')}}: ' + profile + '</li></ul>';
    link = "<a href='javascript:void(0)' onclick='set_target(\"" + full_target + "\");";
    link += "set_profile(\"" + profile + "\");";
    link += "jQuery(\".flash\").html(" + "\"" + msg + "\"" + ").slideDown()'>" + model + "</a>";
    if( typeof full_target != "undefined") {
      if(i < len) {
        list += link + " | "
      } else {
        list += link;
      }
    }
    i++;
  }
  list += '</td></tr>';
list += "</table";
}


document.getElementById('modellist').innerHTML = list

</script>

<h2>Experimental Model list (WIP)</h2>
<strong>This is work in process. So it may or may not work.</strong>

<div class="row-fluid">
  <div class="span6">
    First select the manufacturer of your router:<br />
    <select id="select_manufacturer" onchange='get_model()'></select><br />
    then select the router model:<br />
    <select id="select_model" onchange='show_info_selected()'></select><br />
    <div id="routerinfo"></div>
  </div>
  <div class="span6">
    <div id="routerimage"></div>
  </div>
</div>

<script type="text/javascript">

var routerinfo = [];

function get_manufacturer(){
    $.getJSON('/routerdb/api.json?get=manufacturer', '', function (data, textStatus){
        var html = '<option value="">-- Select manufacturer --</option>';
        var len = data['result'].length;
        for (var i = 0; i< len; i++) {
            html += '<option value="' + data['result'][i].id + '">' + data['result'][i].manufacturer + '</option>';
        }
        $('#select_manufacturer').append(html);
        //get_model();
    });
};

function get_model(){
    document.getElementById('select_model').innerHTML = '';

    $.getJSON('/routerdb/api.json?get=router&search=router.id_manufacturer=' + $("#select_manufacturer option:selected").val() + '', function (data, textStatus){
        var data = data['result']
        var html = '<option value="">-- Select model --</option>';

        var rinfo = '';
        var rimage = '';
        var len = data.length;
        var version = 'Attitude Adjustment 12.09';
        var target, subtarget, profile;

        for (var i = 0; i< len; i++) {
            //get target/subtarget/profile
            var firmware = data[i]['firmware'];
            for (var j = 0; j< firmware.length; j++) {
                if (firmware[j].release == version) {
                    target = firmware[j].target;
                    profile = firmware[j].profile;
                    subtarget = firmware[j].subtarget;
                    factory = firmware[j].factory;
                    sysupgrade = firmware[j].sysupgrade;

                }
            }

            if (data[i].rev) {
                html += '<option value="' + data[i].id + '">' + data[i].model + ' - ' + data[i].rev + '</option>';
            } else {
                html += '<option value="' + data[i].id + '">' + data[i].model + '</option>';
            }
            rinfo += '<div style="display:none" id="rinfo-' + data[i].id + '">';
            rinfo += '<h4>' + data[i].manufacturer + ' ' + data[i].model + ' ' + data[i].rev + '</h4>';
            rinfo += '<table>'
            rinfo += '<tr><td><strong>RAM</strong></td><td>' + data[i].ramsize + ' MB</td></tr>';
            rinfo += '<tr><td><strong>Flash</strong></td><td>' + data[i].flashsize + ' MB</td></tr>';
            rinfo += '<tr><td><strong>Target</strong></td><td>' + target + '</td></tr>';
            rinfo += '<tr><td><strong>Subtarget</strong></td><td>' + subtarget + '</td></tr>';
            rinfo += '<tr><td><strong>Profile</strong></td><td>' + profile + '</td></tr>';
            rinfo += '</table>';

            routerinfo[data[i].id] = {
                                         'model': data[i].model,
                                         'rev': data[i].rev,
                                         'factory': factory,
                                         'sysupgrade': sysupgrade,
                                     };

            //this rewrites target to the latest version
            var full_target = target_rewrite(target);
            var msg = '{{=T('Selected')}} ' + data[i].model + '<ul><li>{{=T('Target')}}: ' + full_target + '</li><li>{{=T('Profile')}}: ' + profile + '</li></ul>';
            rinfo += "<a href='javascript:void(0)' onclick='set_routerinfo(); set_target(\"" + full_target + "\");";
            rinfo += "set_profile(\"" + profile + "\");";
            rinfo += "jQuery(\".flash\").html(" + "\"" + msg + "\"" + ").slideDown()'>Apply settings</a>";
            rinfo += '</div>';

            if (data[i].thumbnail) {
                rimage += '<div style="display:none" id="rimage-' + data[i].id + '">';
                rimage += '<img style="width:100%" src="/routerdb/download/' + data[i].thumbnail + '"><br />';
                rimage += '</div>';
            }

        }

        $('#routerinfo').append(rinfo);
        $('#routerimage').append(rimage);
        $('#select_model').append(html);
        //show_info_selected();
    });
};

function show_info_selected() {
    $('#routerinfo div').hide();
    $('#routerimage div').hide()
    var selectedID = $("#select_model option:selected").val();
    $('#rinfo-' + selectedID).fadeIn('slow');
    $('#rimage-' + selectedID).fadeIn('slow');
}

function set_routerinfo() {
    var selectedID = $("#select_model option:selected").val();
    var routerinfoselected = routerinfo[selectedID];
    //$('input[name="routerinfo"]').val(escape(JSON.stringify(routerinfoselected)));
    $('input[name="routerinfo"]').val(JSON.stringify(routerinfoselected));
}

get_manufacturer();



</script>

{{block footer}}
{{include 'footer.html'}}
{{end}}
